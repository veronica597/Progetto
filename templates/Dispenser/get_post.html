<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Get to the ESP8266</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous">
    </script>
    <script src="https://code.highcharts.com/highcharts.src.js"></script>
    

    <script type="text/javascript" >

        $(document).ready(function (){
            console.log("pronti alla get");
       
            
            //var INDIRIZZO_IP = "192.168.1.105"; // indirizzo IP del computer
            //var urlHome = "http://192.168.1.105:8000/dispenser/";

            // Casa Chiara
            var DEVICE_IP = '192.168.1.128'; // indirizzo IP della scheda ESP8266
            var url = "http://192.168.1.105:8000/dispenser/sensor/";

            // MICC
            //var DEVICE_IP = '192.168.1.134';
            //var url = "http://INDIRIZZO_IP:8000/dispenser/client/";

            // HUAWEI P30 lite -- 192.168.43.37
            //var DEVICE_IP = '192.168.43.128';
            //var url = "http://192.168.43.37:8000/dispenser/client/";


            // RIGUARDARE 
            
            function attivaServo(){ 
                console.log("click sul bottone 'Ruota il servo'");
                var requestUrl = "http://" + DEVICE_IP + "/servoOpen";
                $.get(requestUrl, function(){
                    alert("sto facendo una get all'ESP8266");
                });

            }
                    

            $("#on").click(attivaServo);
        
        });


    </script>
    <!-- controllare con la cartella static -->

</head>

<body>

    <h1 id="tit"> Let's play with the servo </h1>

    <!-- parte da matchare con arduino -->
    <div id="arduino">

        <button id="on" type="button" class="btn btn-primary btn-lg "> Erogate food </button>

    </div>

    <div id="stampa"></div>
    
    <div id="no_erog"> </div>
    
<!--   grafico e tabella -->
    <div id="container"></div>
    
    <table id="oggi">
        <tr id="prova">
            <th>Id</th>
            <th>Data</th>
            <th>Erogation</th>
            <th>UserMode</th>
            <th>TimeMode</th>
        </tr>
        
        

        {% for riga in righe %}
        <tr id="old">

            <td id="id"> {{riga.id}} </td>
            <td id="date"> {{riga.date}} </td>
            <td id="erogation"> {{riga.erogation}} </td>
            <td id="userMod"> {{riga.userMod}} </td>
            <td id="timeMod"> {{riga.timeMod}} </td>


        </tr>
        {% endfor %}

    </table>
    
        
     <script type="text/javascript">
        
      //$(document).ready(function (){
         
         
         // formatta data in ingresso 
         
         function formatDate(date){
             var mesi = ['Gen.', 'Feb.', 'Mar.', 'Apr.', 'May.', 'Jun.', 'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'];
             var i = 0; 
             
             while(i < mesi.length){
                 if(date.getMonth() == i){
                    var month = mesi[i]; 
                 }
                 i++; 

             }
             
             var hours = date.getHours(); 
             var minutes = date.getMinutes(); 
             var ampm = hours >= 12 ? 'p.m.' : 'a.m.'; 
             
             hours = hours % 12; 
             hours = hours ? hours : 12; 
             minutes = minutes < 10 ?  '0' + minutes : minutes; 
             var strTime = month + ' ' + date.getDate() + ', ' + date.getFullYear() + ', ' + hours + ':' + minutes + ' ' + ampm; 
             //var strTime = hours + ':' + minutes + ' ' + ampm; 
             return strTime; 
         }
         
         
         
         
         
        
         // grafico 
                var chart = Highcharts.chart('container', {
                    chart: {
                        type: 'column', // column
                        events: {
                            
                            load: function () {
//                                console.log("dentro load");

                            // POLLING

                            setInterval(function () {
                                console.log("aggiornamento");
                                
                                $.ajax({
                                    type: 'GET',
                                    url: "http://192.168.1.105:8000/dispenser/giorno/",
                                    //url: "http://172.17.196.174:8000/dispenser/giorno/",
                                    //url: "http://localhost:8000/dispenser/giorno/",
                            
                                    success: function(data){
                                        console.log("dati ricevuti"); 
                                        console.log(typeof(data)); 
                                     
                                        var series0 = chart.series[0]; // erogazioni 
                                        console.log(series0.yData); 
                                        var series1 = chart.series[1]; // no erogazioni

                                        var lastId = $('#oggi tr:last').find('#id').html(); 
                                        console.log(lastId); 
                                        var lastDate = $('#oggi tr:last').find('#date').html(); 
                                        console.log(lastDate); 
                                        var lastErog = $('#oggi tr:last').find('#erogation').html(); 
                                        console.log(lastErog); 
                                        var lastUser = $('#oggi tr:last').find('#userMod').html(); 
                                        console.log(lastUser); 
                                        var lastTime = $('#oggi tr:last').find('#timeMod').html(); 
                                        console.log(lastTime); 
                                        
                                        
                                        if(typeof(data) === 'string'){
                                            $('#no_erog').html(data).css({color:'red'}); 
                                            $('#container').hide();
                                            $('#oggi').hide();
                                        }

                                        else{
                                            $('#no_erog').hide();
                                            $('#container').show();
                                            $('#oggi').show();
                                         
                                            
                                            if((typeof lastDate === 'undefined' && typeof lastErog === 'undefined' && typeof lastUser === 'undefined' && typeof lastTime === 'undefined') ||(lastId != data['id'])){

                                        // se i dati precedenti sono undefined, ovvero non esistono (es: primo dato della giornata)

                                        // oppure i dati precedenti sono diversi dai dati appena ricevuti

                                        // allora li renderizzo
                                                console.log("i dati sono undefined o sono diversi a quelli precedenti");
                                                
                                                var d = new Date(data['date']); 
                                        
                                               // formatto i dati in ingresso in modo da rispettare il formato presente nella tabella 

                                                var formatData = formatDate(d); 
                                                console.log("DATA: " + formatData);
                                                
                                                console.log(typeof data['erogation']);

                                                var e = data['erogation'].toString(); 
                                                var E = e.substr(0,1).toUpperCase() + e.substr(1); // trasformo true/false in True/False
                                                console.log(E);

                                                var u = data['userMod'].toString();
                                                var U = u.substr(0,1).toUpperCase() + u.substr(1); 
                                                console.log(U);

                                                var t = data['timeMod'].toString();
                                                var T = t.substr(0,1).toUpperCase() + t.substr(1); 
                                                console.log(T);

                                                $('#oggi tr:last').after("<tr id='last_insert'>" + "<td id='id'>" + data['id'] + "</td>" + "<td id='date'>" + ' ' + formatData + "</td>" +
                                                "<td id='erogation'>" + E + "</td>" + "<td id='userMod'>" + U + "</td>" +
                                                "<td id='timeMod'>" + T + "</td>" + "</tr>"); // riguardare

                                                if(data['erogation'] == true){
                                                 
                                                    series0.setData([series0.yData[0] + 1]);
                                              
                                                }
                                                    
                                                else{ // no erogazioni 
                                                  
                                                    series1.setData([series1.yData[0] + 1]);
                                                }
                                            }

                                            
                                            else{
                                                console.log("dati già stampati");
                                            }
                                            
                                        } // chiude l'else di controllo sui dati 

                                        
                                        
                                    } // chiude success 
                                
                                }); // chiude ajax



                            }, 1000);
                            
                            
                        }  // chiude load 
                    }, // chiude events

                    }, // chiude chart 
                    
                    
                    title: {
                        text: 'Erogazioni di oggi'
                    },
                    
                    // sistemare xAxis

//                    xAxis: {
//                        categories: [data[0]]
//                    },

                    series: [{
                        name: 'Erogazioni',
                        color: '#ff00ff',
                        data: [{{erog}}],
                        
                    }
                             
                    , {
                        name: 'No erogazioni',
                        color: '#00bfff',
                        data: [{{noErog}}],
                        
                          
                   }
                    ],
                    





                }); 
   
         
        
         
         
         
         
      //});
    
    
    </script>

</body>

</html>
