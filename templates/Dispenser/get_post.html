<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Get to the ESP8266</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script type="text/javascript" >

        $(document).ready(function (){
            console.log("pronti alla get");

            //var INDIRIZZO_IP = "192.168.1.105"; // indirizzo IP del computer
            //var urlHome = "http://192.168.1.105:8000/dispenser/";

            // Casa Chiara
            var DEVICE_IP = '192.168.1.128'; // indirizzo IP della scheda ESP8266
            var url = "http://192.168.1.105:8000/dispenser/sensor/";

            // MICC
            //var DEVICE_IP = '192.168.1.134';
            //var url = "http://INDIRIZZO_IP:8000/dispenser/client/";

            // HUAWEI P30 lite -- 192.168.43.37
            //var DEVICE_IP = '192.168.43.128';
            //var url = "http://192.168.43.37:8000/dispenser/client/";

            var data = {
                erogation : 0, // no erogazione
                userMod : 0, // modalita' automatica
                timeMod : 1, // modalita' giorno
            };


            var dataJson = JSON.stringify(data); // converto l'oggetto JS in una stringa JSON

            function success(d){
                $(d).css({border:"3px solid orange"});
            }

            function attivaServo(){
                console.log("click sul bottone 'Ruota il servo'");
                var requestUrl = "http://" + DEVICE_IP + "/servoOpen";
                $.get(requestUrl, function(){
                    alert("sto facendo una get all'ESP8266");
                    var buttonON = $("#on");
                    data.erogation = 1; // erogazione effettuata
                    data.userMod = 1; // modalita' utente
                    dataJson = JSON.stringify(data);
                    //$.post(url, dataJson, success(buttonON));

                    // prova richiesta ajax 1
<!--                    $.ajax({-->
<!--                        url: url,  -->
<!--                        type: 'POST',-->
<!--                        data: dataJson,-->
<!--                        dataType: 'json',-->

<!--                        success: function(){-->
<!--                            console.log("sto facendo una richiesta ajax al server django");-->
<!--                            $("#stampa").html("Il servo ha ruotato");-->
<!--                        },-->
<!--                        error: function(request, error){-->
<!--                            alert("Request: " + JSON.stringify(request));-->
<!--                        }-->
<!--                    });-->

                    // prova ajax 2
                    var xhr = new XMLHttpRequest();
                    //xhr.setRequestHeader('X-Requested-With', 'XMLHttpRequest');
                    xhr.onreadystatechange = function(){
                        if(this.readyState == 4 && this.status == 200){
                            console.log("ajax ok");
                            document.getElementById("stampa").innerHTML = this.responseText;
                            // nella pagina stampo la tabella con tutte le righe del database
                        }
                    };

                    xhr.open("GET", url, true);
                    xhr.send();


                });

            }


            $("#on").click(attivaServo);

        });


    </script>
    <!-- controllare con la cartella static -->

</head>

<body>

    <h1 id="tit"> Let's play with the servo </h1>

    <!-- parte da matchare con arduino -->
    <div id="arduino">



        <button id="on" type="button" class="btn btn-primary btn-lg "> Erogate food </button>

    </div>

    <div id="stampa"></div>

</body>

</html>
